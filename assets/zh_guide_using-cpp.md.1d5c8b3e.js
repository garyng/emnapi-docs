import{_ as n,c as s,o as a,a as o}from"./app.d36eb383.js";const N='{"title":"\u4F7F\u7528 C++ \u5305\u88C5\u5668","description":"","frontmatter":{},"headers":[],"relativePath":"zh/guide/using-cpp.md","lastUpdated":1658320079000}',t={},p=o(`<h1 id="\u4F7F\u7528-c-\u5305\u88C5\u5668" tabindex="-1">\u4F7F\u7528 C++ \u5305\u88C5\u5668 <a class="header-anchor" href="#\u4F7F\u7528-c-\u5305\u88C5\u5668" aria-hidden="true">#</a></h1><p>\u4F60\u4E5F\u53EF\u4EE5\u4F7F\u7528\u5B98\u65B9\u7684 C++ wrapper <a href="https://github.com/nodejs/node-addon-api" target="_blank" rel="noopener noreferrer">node-addon-api</a>\uFF0C\u5B83\uFF08v5.0.0\uFF09\u5DF2\u88AB\u96C6\u6210\u5728\u8FD9\u4E2A\u5305\u91CC\uFF0C\u4F46\u4E0D\u53EF\u4F7F\u7528 Node.js \u73AF\u5883\u7279\u5B9A\u7684 API\uFF0C\u5982 <code>AsyncContext</code>, <code>Function::MakeCallback</code> \u7B49\u7B49\u3002</p><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>\u4F7F\u7528 C++ wrapper \u7F16\u8BD1\u51FA\u7684\u4EE3\u7801\u53EA\u80FD\u8FD0\u884C\u5728 Node.js v14.6.0+ \u548C\u652F\u6301 <code>FinalizationRegistry</code> \u548C <code>WeakRef</code> \u7684\u73B0\u4EE3\u6D4F\u89C8\u5668\uFF08<a href="https://v8.dev/blog/v8-release-84" target="_blank" rel="noopener noreferrer">v8 \u5F15\u64CE v8.4+</a>)\uFF01</p></div><p>\u521B\u5EFA <code>hello.cpp</code>\u3002</p><div class="language-cpp"><pre><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;napi.h&gt;</span></span>

Napi<span class="token double-colon punctuation">::</span>String <span class="token function">JsHello</span><span class="token punctuation">(</span><span class="token keyword">const</span> Napi<span class="token double-colon punctuation">::</span>CallbackInfo<span class="token operator">&amp;</span> info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Napi<span class="token double-colon punctuation">::</span>Env env <span class="token operator">=</span> info<span class="token punctuation">.</span><span class="token function">Env</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> Napi<span class="token double-colon punctuation">::</span><span class="token class-name">String</span><span class="token double-colon punctuation">::</span><span class="token function">New</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">&quot;world&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Napi<span class="token double-colon punctuation">::</span>Object <span class="token function">Init</span><span class="token punctuation">(</span>Napi<span class="token double-colon punctuation">::</span>Env env<span class="token punctuation">,</span> Napi<span class="token double-colon punctuation">::</span>Object exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  exports<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>Napi<span class="token double-colon punctuation">::</span><span class="token class-name">String</span><span class="token double-colon punctuation">::</span><span class="token function">New</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              Napi<span class="token double-colon punctuation">::</span><span class="token class-name">Function</span><span class="token double-colon punctuation">::</span><span class="token function">New</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> JsHello<span class="token punctuation">,</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> exports<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">NODE_API_MODULE</span><span class="token punctuation">(</span>NODE_GYP_MODULE_NAME<span class="token punctuation">,</span> Init<span class="token punctuation">)</span>
</code></pre></div><p>\u4F7F\u7528 <code>em++</code> \u7F16\u8BD1 <code>hello.cpp</code>\u3002Emscripten \u9ED8\u8BA4\u7981\u7528 C++ \u5F02\u5E38\uFF0C\u6240\u4EE5\u8FD9\u91CC\u4E5F\u9884\u5B9A\u4E49\u4E86 <code>-DNAPI_DISABLE_CPP_EXCEPTIONS</code> \u548C <code>-DNODE_ADDON_API_ENABLE_MAYBE</code>\u3002\u5982\u679C\u60F3\u542F\u7528 C++ \u5F02\u5E38\uFF0C\u8BF7\u6539\u7528 <code>-sDISABLE_EXCEPTION_CATCHING=0</code> \u5E76\u5220\u6389 <code>.Check()</code> \u8C03\u7528\u3002\u8BF7\u5728<a href="https://github.com/nodejs/node-addon-api/blob/main/doc/error_handling.md" target="_blank" rel="noopener noreferrer">\u8FD9\u91CC</a>\u67E5\u770B\u5B98\u65B9\u6587\u6863\u3002</p><div class="language-bash"><pre><code>em++ -O3 <span class="token punctuation">\\</span>
     -DNAPI_DISABLE_CPP_EXCEPTIONS <span class="token punctuation">\\</span>
     -DNODE_ADDON_API_ENABLE_MAYBE <span class="token punctuation">\\</span>
     -I./node_modules/@tybys/emnapi/include <span class="token punctuation">\\</span>
     --js-library<span class="token operator">=</span>./node_modules/@tybys/emnapi/dist/library_napi.js <span class="token punctuation">\\</span>
     -sEXPORTED_FUNCTIONS<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">&#39;_malloc&#39;</span>,<span class="token string">&#39;_free&#39;</span><span class="token punctuation">]</span> <span class="token punctuation">\\</span>
     -o hello.js <span class="token punctuation">\\</span>
     ./node_modules/@tybys/emnapi/src/emnapi.c <span class="token punctuation">\\</span>
     hello.cpp
</code></pre></div>`,7),e=[p];function c(l,u,i,k,r,d){return a(),s("div",null,e)}var b=n(t,[["render",c]]);export{N as __pageData,b as default};
